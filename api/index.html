<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farcaster En Çok Etkileşime Girenler (Web3)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght100..900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .primary-bg { background-color: #793FEF; }
        .primary-text { color: #793FEF; }
        .transaction-button:disabled { opacity: 0.6; cursor: not-allowed; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

<div class="w-full max-w-lg bg-white shadow-xl rounded-2xl p-6 md:p-8">
    <header class="text-center mb-6">
        <h1 class="text-3xl font-extrabold text-gray-900 flex items-center justify-center">
            Farcaster Etkileşim Analizcisi
        </h1>
    </header>

    <!-- Cüzdan Bağlantısı -->
    <div id="wallet-section" class="mb-6 p-4 border border-indigo-200 bg-indigo-50 rounded-xl">
        <div class="flex items-center justify-between text-sm font-medium">
            <span>Ağ: <span id="network-info" class="font-bold text-red-500">Yükleniyor...</span></span>
            <span>Cüzdan: <span id="wallet-info" class="font-bold text-red-500">Bağlı Değil</span></span>
            <button id="connect-wallet-button" class="flex items-center primary-bg text-white font-semibold py-2 px-4 rounded-lg hover:opacity-90 transition duration-150 shadow-md" onclick="connectWallet()">Cüzdanı Bağla (MetaMask)</button>
        </div>
        <p id="tx-info" class="text-xs mt-2 text-center text-red-600 hidden">Lütfen MetaMask işlemini onaylayın...</p>
    </div>

    <!-- Kullanıcı Girişi -->
    <div id="input-section" class="mb-6">
        <label for="fname" class="block text-sm font-medium text-gray-700 mb-2">Farcaster Kullanıcı Adınızı Girin:</label>
        <div class="flex space-x-2">
            <input type="text" id="fname" placeholder="örn: dwr" class="flex-grow p-3 border border-gray-300 rounded-lg" required>
            <button id="analyze-button" class="bg-gray-400 text-white font-semibold py-3 px-5 rounded-lg transition duration-150 shadow-md flex items-center justify-center cursor-not-allowed transaction-button" onclick="analyzeEngagers()" disabled>Analiz Et</button>
        </div>
        <p id="error-message" class="text-red-500 text-sm mt-2 hidden"></p>
    </div>

    <!-- Sonuç Alanı -->
    <div id="results-section" class="hidden">
        <h2 class="text-xl font-bold primary-text mb-4 border-b border-gray-200 pb-2">
            <span id="target-fname" class="font-mono bg-indigo-100 px-2 py-0.5 rounded text-base"></span> için En Çok Etkileşime Girenler
        </h2>
        <ul id="engager-list" class="space-y-3 mb-6"></ul>
        <button id="mint-cast-button" class="w-full primary-bg text-white font-semibold py-3 rounded-lg hover:opacity-90 transition duration-150 shadow-lg flex items-center justify-center transaction-button" onclick="mintAndCast()">NFT Bas ve Farcaster'a Yayınla!</button>
        <p id="counter-display" class="mt-4 text-sm text-center text-gray-600">Sayaç Durumu: Yükleniyor...</p>
    </div>

    <div id="loading-indicator" class="hidden flex justify-center items-center p-8">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 primary-text border-t-2 border-indigo-500"></div>
        <p class="ml-3 text-gray-600">İşlem yapılıyor, lütfen MetaMask'i kontrol edin...</p>
    </div>
</div>

<script>
const TARGET_CHAIN_ID_DEC = 8453;
const TARGET_CHAIN_ID_HEX = '0x2105';
const TARGET_NETWORK_NAME = 'Base';
const CONTRACT_ADDRESS = "0xSIIN_BASE_MAINNET_KONTRAT_ADRESINIZ"; 
const CONTRACT_ABI = [
    { "inputs": [], "name": "incrementCounter", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
    { "inputs": [ { "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "tokenId", "type": "uint256" } ], "name": "mintMemorialNFT", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
    { "inputs": [], "name": "counter", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }
];

let provider, signer, contract, walletAddress=null, lastAnalysisResult=null;
const fnameInput = document.getElementById('fname');
const analyzeButton = document.getElementById('analyze-button');
const mintCastButton = document.getElementById('mint-cast-button');
const loadingIndicator = document.getElementById('loading-indicator');
const resultsSection = document.getElementById('results-section');
const engagerList = document.getElementById('engager-list');
const targetFnameSpan = document.getElementById('target-fname');
const errorMessage = document.getElementById('error-message');
const connectWalletButton = document.getElementById('connect-wallet-button');
const walletInfoSpan = document.getElementById('wallet-info');
const networkInfoSpan = document.getElementById('network-info');
const counterDisplay = document.getElementById('counter-display');
const txInfo = document.getElementById('tx-info');

// Helper Functions
function shortenAddress(address) { return address ? address.substring(0,6)+'...'+address.slice(-4) : 'Bilinmiyor'; }

async function switchToBaseNetwork() {
    if (!provider) return false;
    try {
        const network = await provider.getNetwork();
        if(network.chainId === TARGET_CHAIN_ID_DEC) { networkInfoSpan.textContent=TARGET_NETWORK_NAME.toUpperCase(); networkInfoSpan.classList.add('text-green-600'); return true; }
        await window.ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId: TARGET_CHAIN_ID_HEX }] });
        networkInfoSpan.textContent=TARGET_NETWORK_NAME.toUpperCase(); networkInfoSpan.classList.add('text-green-600');
        return true;
    } catch (err) { console.error(err); return false; }
}

async function connectWallet() {
    if(typeof window.ethereum === 'undefined') { errorMessage.textContent='MetaMask kurulu değil!'; errorMessage.classList.remove('hidden'); return; }
    loadingIndicator.classList.remove('hidden'); errorMessage.classList.add('hidden'); txInfo.classList.add('hidden');
    try {
        const accounts = await window.ethereum.request({ method:'eth_requestAccounts' });
        walletAddress = accounts[0];
        provider = new ethers.providers.Web3Provider(window.ethereum);
        const networkSwitchSuccess = await switchToBaseNetwork();
        if(!networkSwitchSuccess) return;
        signer = provider.getSigner();
        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
        walletInfoSpan.textContent = shortenAddress(walletAddress); walletInfoSpan.classList.add('text-green-600');
        connectWalletButton.textContent='Bağlandı'; connectWalletButton.disabled=true; connectWalletButton.classList.replace('primary-bg','bg-green-600');
        analyzeButton.disabled=false; analyzeButton.classList.replace('bg-gray-400','primary-bg'); analyzeButton.classList.replace('cursor-not-allowed','cursor-pointer');
        await fetchCounterValue();
    } catch(err){ console.error(err); errorMessage.textContent='Cüzdan bağlantısı reddedildi.'; errorMessage.classList.remove('hidden'); }
    finally{ loadingIndicator.classList.add('hidden'); }
}

async function fetchCounterValue() { if(!contract) return; try{ const count = await contract.counter(); counterDisplay.textContent=`Sayaç Durumu: ${count.toString()}`; } catch(err){ console.error(err); counterDisplay.textContent='Sayaç Durumu: Hata'; } }

async function handleIncrementCounter() { try{ const tx=await contract.incrementCounter(); await tx.wait(); await fetchCounterValue(); return true; } catch(err){ console.error(err); return false; } }

async function handleMintNFT() { try{ const currentCounter = await contract.counter(); const tokenId = currentCounter.toNumber(); const tx = await contract.mintMemorialNFT(walletAddress, tokenId); await tx.wait(); return tokenId; } catch(err){ console.error(err); throw err; } }

// Backend ile API çağrısı
const fetchEngagers = async (fname) => {
    try {
        const response = await fetch("/api/generate-memorial-nft", {
            method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({fname})
        });
        const data = await response.json();
        if(!data.success) throw new Error(data.error || "Bilinmeyen hata");
        return data.engagers;
    } catch(err){ console.error(err); throw err; }
};

// Ana Akış
async function analyzeEngagers() {
    const fname = fnameInput.value.trim(); errorMessage.classList.add('hidden'); txInfo.classList.add('hidden');
    if(CONTRACT_ADDRESS==="0xSIIN_BASE_MAINNET_KONTRAT_ADRESINIZ"){ errorMessage.textContent='CONTRACT_ADDRESS güncellenmeli!'; errorMessage.classList.remove('hidden'); return; }
    if(!walletAddress || !contract){ errorMessage.textContent='Önce cüzdanınızı bağlayın.'; errorMessage.classList.remove('hidden'); return; }
    if(!fname){ errorMessage.textContent='Kullanıcı adı girin.'; errorMessage.classList.remove('hidden'); return; }
    resultsSection.classList.add('hidden'); loadingIndicator.classList.remove('hidden'); analyzeButton.disabled=true; mintCastButton.disabled=true;

    try {
        const engagers = await fetchEngagers(fname);
        const incrementSuccess = await handleIncrementCounter();
        if(!incrementSuccess) throw new Error("Sayaç artırma başarısız.");
        updateUI(engagers, fname);
    } catch(err){ console.error(err); errorMessage.textContent=`Analiz hatası: ${err.message}`; errorMessage.classList.remove('hidden'); resultsSection.classList.add('hidden'); }
    finally{ loadingIndicator.classList.add('hidden'); analyzeButton.disabled=false; mintCastButton.disabled=false; }
}

function updateUI(engagers,targetFname){
    engagerList.innerHTML=''; targetFnameSpan.textContent=targetFname; lastAnalysisResult=engagers;
    engagers.forEach((user,index)=>{
        const li=document.createElement('li');
        li.className='flex items-center space-x-4 p-4 bg-gray-50 rounded-xl shadow-sm hover:shadow-md';
        li.innerHTML=`
            <div class="flex items-center justify-center w-8 h-8 rounded-full primary-bg text-white font-bold text-lg">${index+1}</div>
            <div class="flex-grow"><p class="text-lg font-semibold primary-text">@${user.fname}</p><p class="text-xs text-gray-500">FID: ${user.fid}</p></div>
            <div class="text-right"><p class="text-sm font-bold text-gray-800">Puan: ${user.engagement_score}</p><p class="text-xs text-gray-500">Yayın: ${user.casts} | Takipçi: ${user.followers}</p></div>`;
        engagerList.appendChild(li);
    });
    resultsSection.classList.remove('hidden');
}

async function mintAndCast(){
    if(!walletAddress || !lastAnalysisResult || !contract){ txInfo.textContent="Önce cüzdan bağlayın ve analiz çalıştırın."; txInfo.classList.remove('hidden'); txInfo.classList.add('text-red-600'); return; }
    loadingIndicator.classList.remove('hidden'); mintCastButton.disabled=true;
    try{
        const nftId = await handleMintNFT();
        const targetFname = targetFnameSpan.textContent;
        const topEngagerNames = lastAnalysisResult.slice(0,3).map(u=>`@${u.fname}`).join(', ');
        const castText = `✅ NFT Basıldı! @${targetFname}'in Top 3 Etkileşimcisi: ${topEngagerNames}. NFT ID: ${nftId}`;
        window.open(`https://warpcast.com/~/compose?text=${encodeURIComponent(castText)}`,'_blank');
    }catch(err){ console.error(err); }
    finally{ loadingIndicator.classList.add('hidden'); mintCastButton.disabled=false; }
}

document.addEventListener('DOMContentLoaded',()=>{
    analyzeButton.disabled=true;
    if(typeof window.ethereum!=='undefined'){
        window.ethereum.on('accountsChanged',()=>window.location.reload());
        window.ethereum.on('chainChanged',()=>window.location.reload());
    }else{ networkInfoSpan.textContent="MetaMask Yok"; networkInfoSpan.classList.add('text-red-500'); }
});
</script>

</body>
</html>
